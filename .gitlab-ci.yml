stages:
  - build-plugin
  - test-plugin

default:
  image: docker.grammatech.com/rewriting/gtirb-ghidra-plugin
  tags: ["kubernetes"]

build-plugin:
  stage: build-plugin
  artifacts:
    paths: 
    - /home/testdir/plugin.zip
    expire_in: 1 day
  script:
  - echo "Building plugin..."
  - cd /home/testdir
  - git clone https://git.grammatech.com/rewriting/gtirb.git
  - cd gtirb
  - protoc --java_out=java --proto_path=proto ./proto/*.proto
  - cd /home/testdir
  - git clone https://git.grammatech.com/rewriting/gtirb-ghidra-plugin.git
  - cp -r /home/testdir/gtirb/java/com/grammatech/gtirb /home/testdir/gtirb-ghidra-plugin/Gtirb/src/main/java/com/grammatech
  - cp /home/testdir/protobuf-java-${PROTOBUF_VERSION}.jar /home/testdir/gtirb-ghidra-plugin/Gtirb/lib
  - cd /home/testdir/gtirb-ghidra-plugin/Gtirb
  - gradle
  - cd /home/testdir/gtirb-ghidra-plugin/Gtirb/dist
  - cp *.zip /home/testdir/plugin.zip
#  - mv *.zip ${GHIDRA_INSTALL_DIR}/Extensions/Ghidra/${GHIDRA_DOWNLOAD_VERSION}_Gtirb.zip
  
test-plugin:
  stage: test-plugin
  needs: [build-plugin]
  script:
  - mv /home/testdir/plugin.zip ${GHIDRA_INSTALL_DIR}/Extensions/Ghidra/${GHIDRA_DOWNLOAD_VERSION}_Gtirb.zip
  - cd ${GHIDRA_INSTALL_DIR}/Ghidra/Extensions
  - unzip ../../Extensions/Ghidra/${GHIDRA_DOWNLOAD_VERSION}_Gtirb.zip
  - cd /home/testdir
  - ./test-import